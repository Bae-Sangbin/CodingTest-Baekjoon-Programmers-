-- -- 인라인 뷰 + 윈도우 함수
-- SELECT
--     TO_NUMBER(MONTH) AS MONTH, CAR_ID, RECORDS
-- FROM (
--     SELECT DISTINCT
--         CAR_ID, 
--         TO_CHAR(START_DATE, 'MM') AS MONTH,
--         COUNT(HISTORY_ID) OVER(PARTITION BY CAR_ID) AS CNT, -- 8월부터 10월까지 자동차별 총 대여횟수
--         COUNT(HISTORY_ID) OVER(PARTITION BY TO_CHAR(START_DATE, 'MM'), CAR_ID) AS RECORDS -- 8월부터 10월까지 월별 자동차별 대여횟수
--     FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
--     WHERE START_DATE
--     BETWEEN TO_DATE('2022-08-01', 'YYYY-MM-DD')
--         AND TO_DATE('2022-10-31', 'YYYY-MM-DD')
--     )
-- WHERE CNT >= 5
-- ORDER BY MONTH, CAR_ID DESC;


SELECT
    TO_NUMBER(MONTH) AS MONTH, CAR_ID, RECORDS
FROM (
    SELECT DISTINCT
        CAR_ID, 
        TO_CHAR(START_DATE, 'MM') AS MONTH,
        COUNT(HISTORY_ID) OVER(PARTITION BY CAR_ID) AS CNT, -- 8월부터 10월까지 자동차별 총 대여횟수
        COUNT(HISTORY_ID) OVER(PARTITION BY TO_CHAR(START_DATE, 'MM'), CAR_ID) AS RECORDS -- 8월부터 10월까지 월별 자동차별 대여횟수
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
    WHERE START_DATE
    BETWEEN TO_DATE('2022-08', 'YYYY-MM')
        AND TO_DATE('2022-10-31', 'YYYY-MM-DD')
    )
WHERE CNT >= 5
ORDER BY MONTH, CAR_ID DESC;